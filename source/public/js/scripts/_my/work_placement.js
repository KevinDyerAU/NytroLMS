var WorkPlacement=function(e){return e.init=()=>{e.setupDatePicker(),e.formHandling(),e.setupForm()},e.setupForm=()=>{let e=document.getElementById("consultation_completed");const t=document.querySelectorAll("#work-placement-form input, #work-placement-form textarea, #work-placement-form .date-picker");if(e){const a=e.cloneNode(!0);e.parentNode.replaceChild(a,e),e=a,e.addEventListener("change",(function(){t.forEach((e=>{"course_id"!==e.id&&"consultation_completed"!==e.id&&(e.disabled=!this.checked,e._flatpickr&&e._flatpickr.altInput&&(e._flatpickr.altInput.disabled=!this.checked))}))})),t.forEach((t=>{"course_id"!==t.id&&"consultation_completed"!==t.id&&(t.disabled=!e.checked,t._flatpickr&&t._flatpickr.altInput&&(t._flatpickr.altInput.disabled=!e.checked))})),document.getElementById("course_id")&&(document.getElementById("course_id").disabled=!1),e.disabled=!1}},e.formHandling=()=>{const t=$("#work-placement-form");t.on("submit",(function(e){e.preventDefault()})),t.length&&t.validate({ignore:[],rules:{course_id:{required:!0},course_start_date:{required:!0},course_end_date:{required:!0}},messages:{course_id:{required:"Please select a course."},course_start_date:{required:"Missing course start date."},course_end_date:{required:"Missing course end date."}},errorPlacement:function(e,t){t.is("select.select2")?e.insertAfter(t.next(".select2-container")):e.insertAfter(t)},submitHandler:function(a,o){o.preventDefault();const r=$("#work-placement-submit");r.prop("disabled",!0).text("Processing..."),e.save().then((()=>{r.prop("disabled",!1).text("Add Work Placement"===t.find(".modal-title").text()?"Proceed":"Update")})).catch((()=>{r.prop("disabled",!1).text("Add Work Placement"===t.find(".modal-title").text()?"Proceed":"Update")}))}})},e.show=(e,t=!1)=>{const a=$("#student-work-placements > .spinner-border"),o=$("#student-work-placements-tab");if(a.length&&a.show(),o.hasClass("loaded")&&!t)return a.hide(),!1;axios.get("/api/v1/work-placements/"+e).then((t=>{if(a.hide(),200===t.status){if(o.find(".content-work-placements").html(t.data.data.html),!$.fn.DataTable.isDataTable("#work-placements-table")&&$("#work-placements-table").length){$("#work-placements-table").DataTable({processing:!0,serverSide:!0,paging:!1,columnDefs:[{targets:0,visible:!0,render:function(e,t,a,o){return'<a onclick="WorkPlacement.edit(event, '+a.id+')" href="#" class="item-view me-1 text-primary" title="Work Placement: '+a.id+'">'+feather.icons.eye.toSvg({class:"font-small-4"})+"</a>"}},{targets:1,visible:!0},{targets:2,visible:!0}],ajax:{url:"/api/v1/work-placements/data/"+e,dataSrc:"data",error:function(e,t,a){console.error("Error:",t),console.log("XHR:",e.responseText)},data:function(e){}},columns:[{data:"id",title:"",orderable:!1,searchable:!1},{data:"user.name",title:"Student",orderable:!1,searchable:!1},{data:"course.title",title:"Course",orderable:!1,searchable:!1},{data:"course_start_date",title:"Course Start",orderable:!1,searchable:!1},{data:"course_end_date",title:"Course End",orderable:!1,searchable:!1},{data:"consultation_completed",title:"Consultation Completed",orderable:!1,searchable:!1},{data:"consultation_completed_on",title:"Consultation Completed On",orderable:!1,searchable:!1},{data:"wp_commencement_date",title:"WP Commencement Date",orderable:!1,searchable:!1},{data:"wp_end_date",title:"WP End Date",orderable:!1,searchable:!1}],buttons:[{extend:"collection",className:"btn btn-outline-secondary dropdown-toggle me-2",text:feather.icons.share.toSvg({class:"font-small-4 me-50"})+"Export",buttons:[{extend:"csv",text:feather.icons["file-text"].toSvg({class:"font-small-4 me-50"})+"CSV",className:"dropdown-item",exportOptions:{columns:":visible"}}]}],language:{emptyTable:"No work placements available",processing:'<div class="spinner-border spinner-border-sm" role="status"><span class="visually-hidden">Loading...</span></div>'},searching:!1,ordering:!1})}a.hide(),o.addClass("loaded")}})).catch((e=>{a.hide();const t=e.response?.data;toastr.error(t?.errors?.[0]?.message||"Error loading work placements.","Error",{closeButton:!0,tapToDismiss:!0})}))},e.delete=(e,t)=>{Swal.fire({title:"Are you sure?",text:"You won't be able to revert this!",icon:"warning",showCancelButton:!0,confirmButtonText:"Yes, delete it!",customClass:{confirmButton:"btn btn-primary",cancelButton:"btn btn-outline-danger ms-1"},buttonsStyling:!1}).then((function(e){e.isConfirmed&&axios.delete("/api/v1/work-placements/"+t).then((e=>{toastr.success(e.data.message,"Success!",{closeButton:!0,tapToDismiss:!0,timeOut:2e3}),$("#work-placements-table").DataTable().ajax.reload()})).catch((e=>{const t=e.response?.data;toastr.error(t?.errors?.[0]?.message||"Error deleting work placement.","Error!",{closeButton:!0,tapToDismiss:!0,timeOut:2e3})}))}))},e.showModal=()=>{const t=$("#work-placement-form");0!==t.length?(t.find(".modal-title").text("Add Work Placement"),t.find('button[type="submit"]').text("Proceed"),t.find("#work_placement_id").remove(),t[0].reset(),$("#selected_course .start_date").text(""),$("#selected_course .end_date").text(""),$("#work-placement-form .date-picker").each((function(){this._flatpickr&&"function"==typeof this._flatpickr.clear&&this._flatpickr.clear()})),$("#work-placement-sidebar").modal("show"),$("#work-placement-sidebar").one("shown.bs.modal",(()=>{e.setupDatePicker(),e.setupForm(),$("#consultation_completed").prop("checked",!1).trigger("change")}))):console.error("Work Placement form not found in the DOM.")},e.edit=(t,a)=>{axios.get("/api/v1/work-placements/show/"+a).then((t=>{const a=t.data.data,o=$("#work-placement-form");$("#work-placement-sidebar").modal("show"),$("#work-placement-sidebar").one("shown.bs.modal",(()=>{e.setupDatePicker();const t=(e,t)=>{const a=document.querySelector(e);if(a&&t&&document.body.contains(a)){a._flatpickr||$(a).flatpickr({altInput:!0,altFormat:"d-m-Y",dateFormat:"Y-m-d"});try{if("string"==typeof t&&/^\d{2}-\d{2}-\d{4}$/.test(t)){const[e,a,o]=t.split("-").map(Number);t=new Date(o,a-1,e)}a._flatpickr.setDate(t,!0,"Y-m-d")}catch(t){console.warn(`Failed to set date for ${e}:`,t)}}};$("#work-placement-sidebar").find(".modal-title").text("Update Work Placement"),o.find('button[type="submit"]').text("Update"),$("#work_placement_id").length>0?$("#work_placement_id").val(a.id):$('<input type="hidden" id="work_placement_id" name="id" value="'+a.id+'" />').insertAfter($("#work-placement-form").find("#course_id")),$("#course_id").val(a.course_id||"").trigger("change"),$("#consultation_completed").prop("checked",a.consultation_completed||!1),t("#consultation_completed_on",a.consultation_completed_on),t("#wp_commencement_date",a.wp_commencement_date),t("#wp_end_date",a.wp_end_date),$("#employer_name").val(a.employer_name||""),$("#employer_email").val(a.employer_email||""),$("#employer_phone").val(a.employer_phone||""),$("#employer_address").val(a.employer_address||""),$("#employer_notes").val(a.employer_notes||""),$("#selected_course .start_date").text(a.course_start_date||""),$("#selected_course .end_date").text(a.course_end_date||""),$("input[name='course_start_date']").val(a.course_start_date||""),$("input[name='course_end_date']").val(a.course_end_date||""),e.setupForm(),$("#consultation_completed").trigger("change")}))})).catch((e=>{console.error("Error in WorkPlacement.edit:",e);const t=e.response?.data?.errors?.[0]?.message||e.message||"Error loading work placement data.";toastr.error(t,"Error",{closeButton:!0,tapToDismiss:!0})}))},e.cancelEditing=()=>{const e=$("#work-placement-form");e.find(".modal-title").text("Add Work Placement"),e.find('button[type="submit"]').text("Proceed"),e.find("#work_placement_id").remove(),e[0].reset(),$("#selected_course .start_date").text(""),$("#selected_course .end_date").text(""),$("#work-placement-sidebar").modal("hide"),$("#course_id").prop("disabled",!1)},e.save=()=>{const t=$("#work-placement-form"),a={user_id:$("#user_id").val()||null,id:$("#work_placement_id").val()||null,course_id:$("#course_id").val()||null,course_start_date:$("input[name='course_start_date']").val()||null,course_end_date:$("input[name='course_end_date']").val()||null,consultation_completed:$("#consultation_completed").is(":checked")||null,consultation_completed_on:$("#consultation_completed_on").val()||null,wp_commencement_date:$("#wp_commencement_date").val()||null,wp_end_date:$("#wp_end_date").val()||null,employer_name:$("#employer_name").val()||null,employer_email:$("#employer_email").val()||null,employer_phone:$("#employer_phone").val()||null,employer_address:$("#employer_address").val()||null,employer_notes:$("#employer_notes").val()||null,company_id:null,leader_id:null};if(!a.course_id)return toastr.warning("Course is required.","Error",{closeButton:!0,tapToDismiss:!0}),Promise.reject("Course is required.");return axios({method:a.id?"put":"post",url:a.id?"/api/v1/work-placements/"+a.id:"/api/v1/work-placements",data:a}).then((a=>{toastr.success(a.data.message,"Success",{closeButton:!0,tapToDismiss:!0}),t[0].reset(),$("#work_placement_id").remove(),$("#work-placements-table").DataTable().ajax.reload(),e.cancelEditing()})).catch((e=>{const t=e.response?.data;throw toastr.error(t?.errors?.[0]?.message||"Error saving work placement.","Error",{closeButton:!0,tapToDismiss:!0}),e}))},e.setupDatePicker=()=>{if("undefined"!=typeof flatpickr){const e=$("#work-placement-form .date-picker");e.length?e.each((function(){$(this).flatpickr({altInput:!0,altFormat:"d-m-Y",dateFormat:"Y-m-d"})})):console.warn("No .date-picker elements found in #work-placement-form")}else console.warn("flatpickr is not loaded")},e}(WorkPlacement||{});
